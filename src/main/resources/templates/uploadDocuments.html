<!DOCTYPE html>
<html th:lang="${#locale.language}" xmlns:th="http://www.thymeleaf.org">
<div th:replace="fragments/head :: head(#{${page.pageTitle}})"></div>
<body>
<div class="page-wrapper">
    <div th:replace="fragments/toolbar :: toolbar"></div>
    <div th:replace="fragments/demoBanner :: demoBanner"></div>
    <section class="slab slab--shiba">
        <div class="grid-ignore-mobile">
            <div th:replace="fragments/cardHeader :: cardHeader"></div>
            <div class="card spacing-above-35">
                <h1 class="h2 text--centered" th:text="#{upload-documents.title}"></h1>
                <div class="spacing-below-60">
                    <div id="dropzone">
                        <form action="/document-upload" class="dropzone needsclick" id="document-upload" method="post"
                              enctype="multipart/form-data">
                            <div id="max-files-reached">
                                <div class='max-files spacing-below-35' id="max-files"
                                     th:text='#{upload-documents.maximum-number-of-files}'></div>
                            </div>
                            <div id="drag-and-drop-box" class="drag-and-drop-box spacing-below-35 spacing-above-35"
                                 ondragenter="addDragBorder()" ondrop="removeDragBorder()"
                                 ondragleave="removeDragBorder()">
                                <h2 class="blue-label text--centered hide-on-mobile narrow-centered-text"
                                    th:text="#{upload-documents.drag-and-drop-or-add-your-files}"></h2>
                                <h2 class="blue-label text--centered hide-on-desktop"
                                    th:text="#{upload-documents.add-your-files}"></h2>
                                <div class="dz-message text--centered">
                                    <button th:aria-label="#{upload-documents.add-your-files}" type="button"
                                            class="button dz-button icon-add"></button>
                                </div>
                                <div id="number-of-uploaded-files" class="text--centered body-gray">
                                </div>
                            </div>
                            <div class="spacing-below-25">
                                <p class="upload-doc-text">Uploaded documents</p>
                            </div>
                            <div id="file-preview-template">
                                <div class="preview-container"></div>
                            </div>

                            <th:block th:with="isEmployed=${data.get('employmentStatus').inputDataValueContainsAny('areYouWorking', T(java.util.List).of('true')) && applicationData.isApplicationWith(T(java.util.List).of('SNAP', 'CASH', 'EA', 'GRH'))},
                                          hasHousingExpenses=${!data.get('homeExpenses').inputDataValueContainsAny('homeExpenses', T(java.util.List).of('NONE_OF_THE_ABOVE')) && applicationData.isApplicationWith(T(java.util.List).of('SNAP', 'CASH', 'EA'))},
                                          hasChangedWorkSituation=${data.get('workSituation').inputDataValueContainsAny('hasWorkSituation', T(java.util.List).of('true')) && applicationData.isApplicationWith(T(java.util.List).of('SNAP', 'CASH', 'GRH'))}">
                                <div class="reveal reveal-adjacent spacing-above-60"
                                     th:if="${isEmployed || hasHousingExpenses || hasChangedWorkSituation}">
                                    <a href="#" class="reveal__link reveal__link-adjacent">
                                    <span class="reveal-icon">
                                        <div th:replace="fragments/icons/icon-multiple-documents  :: icon-multiple-documents"></div>
                                    </span>
                                        <div class="reveal__link__header-adjacent"
                                             th:text="#{upload-documents.view-document-list}"></div>
                                        <div class="reveal__content reveal__content-adjacent">
                                            <div th:if="${isEmployed}">
                                                <h3 class="h4" th:text="#{upload-documents.proof-of-income}"></h3>
                                                <div th:text="#{upload-documents.a-document-with-employer-and-employee-names}"></div>
                                            </div>
                                            <div th:if="${hasHousingExpenses}">
                                                <h3 class="h4 spacing-above-15"
                                                    th:text="#{upload-documents.proof-of-housing-costs}"></h3>
                                                <div th:text="#{upload-documents.a-document-showing-total-amount-paid-for-housing}"></div>
                                            </div>
                                            <div th:if="${hasChangedWorkSituation}">
                                                <h3 class="h4 spacing-above-15"
                                                    th:text="#{upload-documents.proof-of-job-loss}"></h3>
                                                <div th:text="#{upload-documents.a-document-with-your-former-employers-name-and-signature}"></div>
                                            </div>
                                        </div>
                                    </a>

                                </div>
                            </th:block>
                        </form>
                        <form th:action="@{/submit-documents}" method="post" onsubmit="return onSubmit()">
                            <div class="form-group">
                                <button type="submit" class="button button--primary"
                                        th:text="#{upload-documents.im-finished-uploading}"></button>
                                <p class="text--error">
                                    <i class="icon-warning"></i>
                                    <span th:text="#{upload-documents.wait-for-upload-warning}"></span>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<div th:replace="fragments/footer :: footer"></div>
<script th:inline="javascript">
    Dropzone.autoDiscover = false;
    var documentIcon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEsAAABGCAYAAACE0Gk0AAAFK0lEQVR4Xu2caVcTSRSG314SyEJQPIAsMucoihDmzJE1BBhnEZ35xzPjmU9ABAR/AThnFBBQQciedLrn3Epaw6Z9OxsTqr7kQ25XVz31VtWt5baSTiYsyOSIgCJhOeIkjCQs56wkLAYrCasusFKpFF5vbmJ/7x1My4KmqZz3VmRr5A3oHh3DI6Po6e2tKC/Ow67GrJOTE7xaX8PB/gG8Xi8URYFl1XNStZDNZtF+4yamIzO42dHBqbNrWzasbDaDtZUV7GxvIxgMNgAUTUsALCCRSKCzsxMzc3Pw+wOuITh9kA3r9dYmNtZforW1FaqiflEUVaDWqUy8pGbTMpGIx3Fn4DtEorPQdb2mJWDDii0t4mB/Dx6Pt85dj8RkQRGyKiYCZhQMpJJJDN5/gPHJKahq7cZONqznf/6BZCLxuRXtAmfS6RK8WknMgq57hKLLk6KqyGbSSKfTGJuYxPBIuGbqqggWtbRlWtB0HT6fT7RqoVCAUgNeiqLCMPLIZDJFVdkKUyDeSw1Ik8zM7JzolrVIbFh/P/8L8ZMTMXWbBRPpdAq9fX2YikTR0tKCXC5X1lGqV2RN17C3t4dX6y9Fg2iq9iVzhbqkKsrl8/sQnZ1HZ1dX9V5ud3vu2vAsrFQqKVoyOjcvxpBapg8f3mM1FoNhGNC0Mlil8YuUTgN+e/sNROfnxW81U0XKskwTyWRRWSR/j8dTzbKdy+vd7i421tdQMArnYJX6JqhMx8fH6OnpxeyPj8+NcZUUsCqw+vr7EIleAVglheXzOcTjcTwYeojpmWglfE5PJpV0Q1tZVwmWGPxphsxmQDP0D4/GEB79virAmk5ZdncUM2QyiVw2i8npiFBZpak5YRV9C+FSHH/6JFyK+cc/487AQEW8mhdWGbCjw0PhB/70yxN03LrlGlhzwyqNX+TRHH78KECRwtra2lwBa3pYREXViisL6pL9dwYQmYmi1edjA7sWsGxg+XweiXgC94eG8GhsnO0XXhtYtkuRz+VAftjDkTBGwqMXO7eXaO5awRLAFEXAorXkcDjMcimuHSzbDyP/K9TejidPf3M8dv2vYO3u7mBjbRXGZWvDr1T77KYgLcYDwQAWnv3enLBo33/1xTILFjmk1PW8Xg9UVfu8u0uw2kIh/LrwtDlhHR0d4p+tLZimKdZ/ThJt5ZDb8P5gX6wVaaOSNg6bHlY5HKdHb+JgwyxgeXFRnEgFAn4Bms4em1pZTpR0kQ2paCW2jO23b8SRGTmpEtYlNMkZXYktYWd7RyrrW4qTsL5FqOx/CUvCYhBgmEplSVgMAgxTqSwJi0GAYSqVJWExCDBMpbIkLAYBhqlUloTFIMAwlcqSsBgEGKZSWRIWgwDDVCpLwmIQYJhKZUlYDAIMU6ksCYtBgGF6pZRVrwgLBp9TpgTrxfISdncaeMhKgU71jN1xC4vuRVCc5Ns3/zbu+L6eUWFuQFHgK8VwUzz12kpMKMvn89fvrkN5cGY94w1dwbIg7ozSFSUK3iwYBhSVLhwVrxwFgkEsPKvhzb/GRbK6wUXPFC+z0VVuXdNPXWarOaxGxki7xXX2OfsSblf3bREn6TSx75Q2NPreaa0usitF7ttR+xQ+PD4xibv3Bh3nyoZ1Jb7r4Lh6pw3tj3XQ9yD6+vsxFYmgpeV0gPrXsmbDoswa/8UQPi0bFMVwd3V3YWxiCqFQiJWRK1j0hkZ+i4ZVw5JxoWBCVRR03+7B3cFB+P1+djauYbHf1AQPSFiMRpSwJCwGAYbpf7oLq5uJEmkZAAAAAElFTkSuQmCC";
    var dataURL = "";
    var isUploadComplete = true;

    function addDragBorder() {
        var dragAndDropBox = document.getElementById("drag-and-drop-box");
        dragAndDropBox.classList.add("drag-over");
    }

    function removeDragBorder() {
        var dragAndDropBox = document.getElementById("drag-and-drop-box");
        dragAndDropBox.classList.remove("drag-over");
    }

    function getFilenameComponents(element) {
        var name = element.innerText;
        var extIdx = name.lastIndexOf('.');
        if (extIdx === -1) {
            return [name, ""];
        }

        var extStr = name.slice(extIdx + 1, name.length);
        if (element.scrollWidth <= element.clientWidth) {
            extStr = "." + extStr;
        }
        return [name.slice(0, extIdx), extStr];
    }

    function onSubmit() {
        if (!isUploadComplete) {
            $('.form-group').addClass('form-group--error');
            $('.text--error').show();
            return false;
        } else {
            return true;
        }
    }

    function showMaxFileMessage() {
        var dragBox = document.getElementById("drag-and-drop-box");
        dragBox.style.display = "none";
        var maxFilesReached = document.getElementById("max-files");
        maxFilesReached.style.display = "flex";
    }

    $('.text--error').hide();

    var myDropZone;

    function destroyerCreator(file) {
        return function () {
            myDropZone.emit('destroy', file);
        }
    }

    function processDZQueueAfterThumbnailGeneration() {
        var allUploadsHaveThumbnails = myDropZone.getQueuedFiles().every(f => f.dataURL && f.dataURL.length > 0);
        if (allUploadsHaveThumbnails) {
            myDropZone.processQueue();
        }
    }

    function showNumberOfAddedFiles() {
        var numberOfAddedFiles = myDropZone.files.length;
        var numberOfAddedFilesDiv = document.getElementById("number-of-uploaded-files");
        var numberOfUploadsString = numberOfAddedFiles > 1 ? `${numberOfAddedFiles} files added` : `${numberOfAddedFiles} file added`;
        numberOfAddedFilesDiv.innerHTML = numberOfUploadsString;
    }

    var fileTooBigMsg = [[#{upload-documents.this-file-is-too-large(${uploadDocMaxFileSize})}]]

    function setDefaultThumbnail(file) {
        file.dataURL = documentIcon;
        myDropZone.emit("thumbnail", file, documentIcon);
    }

    $("#document-upload").dropzone({
        uploadMultiple: false,
        previewsContainer: ".preview-container",
        autoProcessQueue: false,
        thumbnailMethod: "crop",
        thumbnailWidth: 64,
        thumbnailHeight: 60,
        maxFiles: 20,
        parallelUploads: 1,
        timeout: 0,
        maxFilesize: [[${uploadDocMaxFileSize}]],
        dictFileTooBig: fileTooBigMsg,
        acceptedFiles: ".jpeg,.jpg,.png,.tiff,.pdf,.bmp,.gif,.doc,.docx,.odt,.ods,.odp",
        clickable: ".drag-and-drop-box",
        previewTemplate: `
            <div class="dz-preview dz-file-preview spacing-below-15">
              <div class="dz-details grid">
                <div class="grid__item width-one-sixth mobile-width-one-fourth doc-rectangle">
                    <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
                    <img class="dz-thumb" data-dz-thumbnail aria-hidden="true" />
                </div>
                <div class="grid__item width-five-sixths mobile-width-three-fourths">
                    <div class="dz-filename"><div class="filename-text" data-dz-name></div></div>
                    <div class="display-flex body-gray file-details">
                        <span class="document-info">
                            <div class="file-count"></div>
                            <span class="file-count-delimiter" aria-hidden="true">•</span>
                        </span>
                        <div class="dz-size" data-dz-size></div>
                        <span class="file-details-delimiter" aria-hidden="true">•</span>
                        <a class="dz-remove" href="javascript:undefined;" ></a>
                    </div>
                </div>
              </div>
              <p class='text--error spacing-above-0'></p>
            </div>`,
        init: function () {
            myDropZone = this;
            var documents = [[${uploadedDocs}]];
            if (documents.length >= this.options.maxFiles) {
                showMaxFileMessage();
            }

            this.on('addedfile', function (file) {
                if (myDropZone.files.length >= myDropZone.options.maxFiles) {
                    showMaxFileMessage();
                }
                var fileNameSpan = file.previewElement.getElementsByClassName('filename-text')[0];
                var fileNameComponents = getFilenameComponents(fileNameSpan);
                var removeLink = file.previewElement.getElementsByClassName("dz-remove")[0];
                var thumbnail = file.previewElement.getElementsByClassName("dz-thumb")[0];
                var documentInfo = file.previewElement.getElementsByClassName('document-info')[0];

                fileNameSpan.setAttribute('aria-label', fileNameSpan.innerText);
                fileNameSpan.innerHTML = "<span class='filename-text-name' aria-hidden='true'>" + fileNameComponents[0] + "</span>" +
                    "<span class='filename-text-ext' aria-hidden='true'>" + fileNameComponents[1] + "</span>";

                removeLink.onclick = destroyerCreator(file);
                removeLink.innerText = [[#{general.cancel}]].toLowerCase();

                thumbnail.classList.add("hidden");

                isUploadComplete = false;

                if (!file.type.includes("image")) {
                    setDefaultThumbnail(file);
                    // This hides delimiter for documents since we haven't implemented document count yet, will probably need to refactor when we implement document count
                    documentInfo.classList.add("hidden");
                }
                showNumberOfAddedFiles();
            });

            this.on("thumbnail", function (file, dataURL) {
                setTimeout(function () {
                    processDZQueueAfterThumbnailGeneration()
                }, 1);
            });

            this.on("sending", function (file, xhr, formData) {
                var csrfToken = [[${_csrf.token}]];
                formData.append("_csrf", csrfToken);
                formData.append("dataURL", file.dataURL);
                formData.append("type", file.type);
            })

            this.on('queuecomplete', function () {
                isUploadComplete = true;
                if (documents.length >= this.options.maxFiles) {
                    showMaxFileMessage();
                }
            });

            this.on('maxfilesreached', function () {
                showMaxFileMessage();
            });

            this.on('maxfilesexceeded', function () {
                showMaxFileMessage();
            });

            this.on('success', function (file) {
                var removeLink = file.previewElement.getElementsByClassName("dz-remove")[0];
                var fileCount = file.previewElement.getElementsByClassName('file-count')[0];
                var documentInfo = file.previewElement.getElementsByClassName('document-info')[0];
                var thumbnail = file.previewElement.getElementsByClassName("dz-thumb")[0];
                var fileName = file.name;

                removeLink.onclick = undefined;
                removeLink.setAttribute('href', '/pages/uploadDocumentsDeleteWarningPage?filename=' + encodeURIComponent(fileName));
                removeLink.innerText = [[#{general.delete}]].toLowerCase();
                thumbnail.classList.remove("hidden");

                if (file.type.includes("image")) {
                    fileCount.setAttribute('aria-label', fileCount.innerText);
                    fileCount.innerHTML = "<span>1 image</span>";
                    // The below line is commented out to hide the ' . ' spacer on image upload info until the page count on PDF
                    // story is completed. At that time uncomment the below line along with removing shiba.css
                    // document-info display none rule
                    // documentInfo.style.display = "unset";
                }
            });

            // This lets dropzone know to process the queue after each file has completed
            // Important for uploading multiple files at once
            this.on("complete", function() {
                processDZQueueAfterThumbnailGeneration();
            })

            // `destroy` is a custom event that we have defined, not something built into dropzone.
            // This event is emitted when the client clicks cancel on a file that has not finished uploading.
            this.on('destroy', function (file) {
                myDropZone.removeFile(file);
                showNumberOfAddedFiles()
            });

            $.each(documents, function (key, value) {
                var mockFile = {name: value.filename, size: value.size, type: value.type};
                myDropZone.files.push(mockFile);
                myDropZone.emit("addedfile", mockFile);
                myDropZone.emit("thumbnail", mockFile, value.dataURL);
                myDropZone.emit("success", mockFile);
                myDropZone.emit("complete", mockFile);
            });

        },
        error: function (file, errorMessage, xhr) {
            file.previewElement.getElementsByClassName("text--error")[0].innerText = errorMessage.error ? errorMessage.error : errorMessage;
            file.previewElement.classList.add("form-group--error");

            var removeLink = file.previewElement.getElementsByClassName("dz-remove")[0];
            removeLink.onclick = destroyerCreator(file);
            removeLink.innerText = [[#{general.remove}]].toLowerCase();
            removeLink.classList.add("text--red");

            var filePreview = file.previewElement.getElementsByClassName("doc-rectangle")[0]
            filePreview.innerHTML = "<svg class=\"margin-auto\" width=\"40\" height=\"47\" viewBox=\"0 0 40 47\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n" +
                "<path d=\"M6.625 40.125H20.375L13.5 28.25L6.625 40.125ZM14.125 38.25H12.875V37H14.125V38.25ZM14.125 35.75H12.875V33.25H14.125V35.75Z\" fill=\"#D13F00\"/>\n" +
                "<path d=\"M26.6667 0H4.44444C3.2657 0 2.13524 0.550197 1.30175 1.52955C0.468252 2.50891 0 3.8372 0 5.22222V41.7778C0 43.1628 0.468252 44.4911 1.30175 45.4704C2.13524 46.4498 3.2657 47 4.44444 47H35.5556C36.7343 47 37.8648 46.4498 38.6983 45.4704C39.5317 44.4911 40 43.1628 40 41.7778V15.6667L26.6667 0ZM35.5556 41.7778H4.44444V5.22222H24.4444V18.2778H35.5556V41.7778Z\" fill=\"#D13F00\" fill-opacity=\"0.5\"/>\n" +
                "</svg>";
        }
    });
</script>
</body>
</html>
