<!DOCTYPE html>
<html th:lang="${#locale.language}" xmlns:th="http://www.thymeleaf.org">
<div th:replace="fragments/head :: head(#{${page.pageTitle}})"></div>
<body>
<div class="page-wrapper">
    <div th:replace="fragments/toolbar :: toolbar"></div>
    <div th:replace="fragments/demoBanner :: demoBanner"></div>
    <section class="slab slab--shiba">
        <div class="grid-ignore-mobile">
            <div th:replace="fragments/cardHeader :: cardHeader"></div>
            <div class="card spacing-above-35">
                <h1 class="h2 text--centered" th:text="#{upload-documents.title}"></h1>
                <div class="spacing-below-60">
                    <div id="dropzone">
                        <form action="/file-upload" class="dropzone needsclick" id="document-upload" method="post"
                              enctype="multipart/form-data">
                            <div id="drag-and-drop-box" class="drag-and-drop-box spacing-below-35 spacing-above-35"
                                 ondragenter="addDragBorder()" ondrop="removeDragBorder()"
                                 ondragleave="removeDragBorder()">
                                <h2 class="blue-label text--centered hide-on-mobile narrow-centered-text"
                                    th:text="#{upload-documents.drag-and-drop-or-add-your-files}"></h2>
                                <h2 class="blue-label text--centered hide-on-desktop"
                                    th:text="#{upload-documents.add-your-files}"></h2>
                                <div class="dz-message text--centered">
                                    <button th:aria-label="#{upload-documents.add-your-files}" type="button"
                                            class="button dz-button icon-add"></button>
                                </div>
                            </div>
                            <div class="bottom-horizontal-line spacing-below-25">
                                <p>Uploaded documents</p>
                            </div>
                            <div id="file-preview-template">
                                <div class="preview-container">
                                    <div th:if="${!uploadedDocuments.isEmpty()}">
                                        <th:block th:each="doc : ${uploadedDocuments}">
                                            <div class="dz-preview dz-file-preview">
                                                <div class="dz-details">
                                                    <span class="persisted-file-name" th:text="${doc.filename}"></span>
                                                </div>
                                            </div>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                            <div class="reveal reveal-adjacent">
                                <a href="#" class="reveal__link reveal__link-adjacent">
                                    <span class="reveal-icon">
                                        <div th:replace="fragments/icons/icon-multiple-documents  :: icon-multiple-documents"></div>
                                    </span>
                                    <div class="reveal__link__header-adjacent"
                                         th:text="#{upload-documents.view-document-list}"></div>
                                    <div class="reveal__content reveal__content-adjacent">
                                        <h3 class="h4" th:text="#{upload-documents.proof-of-income}"></h3>
                                        <div th:text="#{upload-documents.a-document-with-employer-and-employee-names}"></div>
                                        <h3 class="h4 spacing-above-15"
                                            th:text="#{upload-documents.proof-of-housing-costs}"></h3>
                                        <div th:text="#{upload-documents.a-document-showing-total-amount-payed-for-housing}"></div>
                                        <h3 class="h4 spacing-above-15"
                                            th:text="#{upload-documents.proof-of-job-loss}"></h3>
                                        <div th:text="#{upload-documents.a-document-with-your-former-employers-name-and-signature}"></div>
                                    </div>
                                </a>
                            </div>
                            <!-- This is temporarily incorrect, but implemented to allow for navigation to the next page for acceptance -->
                            <a id="submit" class="button"
                               th:href="'/pages/'+${pageName}+'/navigation?option=0'"
                               th:text="#{upload-documents.im-finished-uploading}"></a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<div th:replace="fragments/footer :: footer"></div>
<script th:inline="javascript">
    Dropzone.autoDiscover = false;

    function addDragBorder() {
        let dragAndDropBox = document.getElementById("drag-and-drop-box");
        dragAndDropBox.classList.add("drag-over");
    }

    function removeDragBorder() {
        let dragAndDropBox = document.getElementById("drag-and-drop-box");
        dragAndDropBox.classList.remove("drag-over");
    }

    const truncateFileName = (name) => {
        const MAX_LEN = 14
        if (name.length > MAX_LEN) {
            const splitUpName = name.split('.');
            const firstPart = splitUpName.slice(0, -1).join('.')
            const ext = splitUpName.slice(-1)

            return `${firstPart.slice(0, MAX_LEN)}...${ext}`;
        }

        return name;
    }

    const persistedFileNames = document.getElementsByClassName('persisted-file-name');

    for (p of persistedFileNames) {
        p.innerText = truncateFileName(p.innerText);
    }

    $("#document-upload").dropzone({
        uploadMultiple: false,
        addRemoveLinks: false,
        previewsContainer: ".preview-container",
        autoProcessQueue: true,
        clickable: ".drag-and-drop-box",
        previewTemplate: `
            <div class="testing dz-preview dz-file-preview">
              <div class="dz-details">
                <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>
                <div class="dz-filename"><span class="filename-text" data-dz-name></span></div>
              </div>
            </div>`,
        sending: (file, xhr, formData) => {
            const csrfToken = [[${_csrf.token}]];
            formData.append("_csrf", csrfToken)
        },
        init: function () {
            this.on('uploadprogress', (file, progress, bytesSent) => {
                // function wait(ms) {
                //     var start = new Date().getTime();
                //     var end = start;
                //     while (end < start + ms) {
                //         end = new Date().getTime();
                //     }
                // }
                // wait(3000)
            });
            this.on('addedfile', file => {
                const fileNameSpan = file.previewElement.getElementsByClassName('filename-text')[0]
                fileNameSpan.innerText = truncateFileName(fileNameSpan.innerText);
            });
        }
    });
</script>
</body>
</html>